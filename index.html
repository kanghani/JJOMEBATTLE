<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JJOME BATTLE M</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            overflow: hidden;
            touch-action: none; /* ëª¨ë°”ì¼ í„°ì¹˜ í™•ëŒ€ ë°©ì§€ */
            font-family: 'Segoe UI', sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #34495e;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            display: block;
            background: #87CEEB; /* í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* --- UI ì˜¤ë²„ë ˆì´ --- */
        .ui-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            color: white;
        }
        
        .hidden { display: none !important; }

        /* --- ê°€ìƒ ì¡°ì´íŒ¨ë“œ (ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ëŸ¬) --- */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            height: 120px;
            pointer-events: none; /* ë²„íŠ¼ ì™¸ ì˜ì—­ í„°ì¹˜ í†µê³¼ */
            z-index: 10;
            display: none; /* ê²Œì„ ì‹œì‘ í›„ ë³´ì„ */
        }

        .control-group {
            position: absolute;
            bottom: 10px;
            pointer-events: auto;
        }

        #d-pad { left: 20px; }
        #action-pad { right: 20px; }

        .btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            margin: 0 5px;
            touch-action: manipulation;
        }
        
        .btn:active { background: rgba(255, 255, 255, 0.6); }

        /* ìºë¦­í„° ì„ íƒ ìŠ¤íƒ€ì¼ */
        .char-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .char-slot {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            border: 2px solid transparent;
            display: flex; 
            justify-content: center; 
            align-items: center;
        }
        .char-slot.selected { border-color: #f1c40f; background: rgba(241,196,15,0.3); }
        .char-slot img { width: 50px; height: 50px; object-fit: contain; }

        /* ì²´ë ¥ë°” */
        #hud {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            padding: 0 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            z-index: 5;
            display: none;
        }
        .hp-bar-container {
            width: 40%;
            height: 25px;
            background: #333;
            border: 2px solid white;
            border-radius: 5px;
            position: relative;
        }
        .hp-fill {
            height: 100%;
            background: #e74c3c;
            width: 100%;
            transition: width 0.2s;
        }
        .name-tag {
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="hud">
        <div style="width: 40%;">
            <div class="name-tag">YOU</div>
            <div class="hp-bar-container"><div id="p1-hp" class="hp-fill"></div></div>
        </div>
        <div style="width: 40%; text-align: right;">
            <div class="name-tag">CPU</div>
            <div class="hp-bar-container"><div id="p2-hp" class="hp-fill"></div></div>
        </div>
    </div>

    <div id="mobile-controls">
        <div id="d-pad" class="control-group">
            <div class="btn" id="btn-left">â—€</div>
            <div class="btn" id="btn-right">â–¶</div>
        </div>
        <div id="action-pad" class="control-group">
            <div class="btn" id="btn-atk" style="background:rgba(231, 76, 60, 0.4)">A</div>
            <div class="btn" id="btn-jump" style="background:rgba(46, 204, 113, 0.4)">J</div>
        </div>
    </div>

    <div id="start-screen" class="ui-screen">
        <h1 style="color:#f1c40f; font-size: 32px; text-align:center;">JJOME BATTLE M</h1>
        <p>Choose Your Fighter</p>
        <div class="char-grid" id="char-grid"></div>
        <br>
        <button id="start-btn" class="btn" style="width:auto; padding:0 30px; border-radius:20px; font-size:18px;">FIGHT!</button>
    </div>

    <div id="result-screen" class="ui-screen hidden">
        <h1 id="result-text" style="font-size: 40px;">YOU WIN!</h1>
        <button onclick="location.reload()" class="btn" style="width:auto; padding:0 30px; border-radius:20px;">REMATCH</button>
    </div>
</div>

<script>
    /** * JJOME BATTLE M - Mobile 1vsCPU Game 
     */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // í™”ë©´ í¬ê¸° ìë™ ì¡°ì •
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // ì„¤ì •
    const GRAVITY = 0.6;
    const GROUND_H = 100;
    const SPEED = 4;
    const JUMP_POWER = -13;
    const IMG_FILES = ['image_0.png', 'image_1.png', 'image_2.png', 'image_3.png', 'image_4.png', 'image_5.png'];
    
    // ê²Œì„ ìƒíƒœ
    let gameState = 'START'; // START, PLAY, END
    let images = [];
    let p1CharIdx = 0;
    let p2CharIdx = 1;
    let gameLoopId;

    // ì…ë ¥ ìƒíƒœ
    const keys = { left: false, right: false, up: false, atk: false };

    // í´ë˜ìŠ¤: í”Œë ˆì´ì–´ & AI
    class Fighter {
        constructor(x, isCPU, imgIdx) {
            this.x = x;
            this.y = 0;
            this.w = 80;
            this.h = 80;
            this.vx = 0;
            this.vy = 0;
            this.hp = 100;
            this.isCPU = isCPU;
            this.img = images[imgIdx];
            this.facingRight = !isCPU; // P1ì€ ì˜¤ë¥¸ìª½, CPUëŠ” ì™¼ìª½ ë´„
            this.cooldown = 0;
            this.grounded = false;
            
            // AIìš© íƒ€ì´ë¨¸
            this.aiMoveTimer = 0;
            this.aiAction = 0; // 0:ëŒ€ê¸°, 1:ì™¼ìª½, 2:ì˜¤ë¥¸ìª½
        }

        update(target) {
            // 1. ì›€ì§ì„ ì²˜ë¦¬
            if (!this.isCPU) {
                // í”Œë ˆì´ì–´ ì¡°ì‘
                this.vx = 0;
                if (keys.left) { this.vx = -SPEED; this.facingRight = false; }
                if (keys.right) { this.vx = SPEED; this.facingRight = true; }
                if (keys.up && this.grounded) { this.vy = JUMP_POWER; this.grounded = false; }
                if (keys.atk && this.cooldown <= 0) { this.shoot(); this.cooldown = 40; }
            } else {
                // AI ì¡°ì‘ (ê°„ë‹¨í•œ ë¡œì§)
                this.aiUpdate(target);
            }

            // ë¬¼ë¦¬ ì ìš©
            this.vy += GRAVITY;
            this.x += this.vx;
            this.y += this.vy;

            // ë°”ë‹¥ ì¶©ëŒ
            if (this.y + this.h >= canvas.height - GROUND_H) {
                this.y = canvas.height - GROUND_H - this.h;
                this.vy = 0;
                this.grounded = true;
            }

            // ë²½ ë§‰í˜
            if (this.x < 0) this.x = 0;
            if (this.x > canvas.width - this.w) this.x = canvas.width - this.w;

            // ì¿¨ë‹¤ìš´ ê°ì†Œ
            if (this.cooldown > 0) this.cooldown--;
        }

        aiUpdate(target) {
            this.aiMoveTimer++;
            
            // 60í”„ë ˆì„ë§ˆë‹¤ í–‰ë™ ê²°ì •
            if (this.aiMoveTimer > 40) {
                this.aiMoveTimer = 0;
                const rand = Math.random();
                
                // ê±°ë¦¬ ê³„ì‚°
                const dist = Math.abs(this.x - target.x);

                // 1. ê³µê²©: í”Œë ˆì´ì–´ ìª½ì„ ë³´ê³  ì˜ê¸°
                if (rand < 0.4) { // 40% í™•ë¥ ë¡œ ê³µê²© ì‹œë„
                    this.facingRight = (target.x > this.x);
                    if (this.cooldown <= 0) { this.shoot(); this.cooldown = 60; }
                }
                // 2. ì´ë™: ë„ˆë¬´ ë©€ë©´ ë‹¤ê°€ê°€ê³ , ê°€ê¹Œìš°ë©´ ë„ë§
                else if (rand < 0.8) {
                    if (dist > 300) {
                        this.aiAction = (target.x > this.x) ? 2 : 1; // ì¶”ê²©
                    } else if (dist < 100) {
                        this.aiAction = (target.x > this.x) ? 1 : 2; // ë„ë§
                    } else {
                        this.aiAction = 0; // ëŒ€ê¸°
                    }
                }
                // 3. ì í”„
                else if (rand > 0.9 && this.grounded) {
                    this.vy = JUMP_POWER; this.grounded = false;
                }
            }

            this.vx = 0;
            if (this.aiAction === 1) { this.vx = -SPEED * 0.8; this.facingRight = false; }
            if (this.aiAction === 2) { this.vx = SPEED * 0.8; this.facingRight = true; }
        }

        shoot() {
            const pX = this.facingRight ? this.x + this.w : this.x;
            const pY = this.y + this.h / 2;
            const dir = this.facingRight ? 1 : -1;
            // 1PëŠ” í•˜íŠ¸, CPUëŠ” ë³„
            const type = this.isCPU ? 'â˜…' : 'â™¥'; 
            const color = this.isCPU ? '#f1c40f' : '#e74c3c';
            projectiles.push(new Projectile(pX, pY, dir, type, color, this.isCPU));
        }

        draw() {
            // ê·¸ë¦¼ì
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(this.x + this.w/2, canvas.height - GROUND_H + 10, 30, 10, 0, 0, Math.PI*2);
            ctx.fill();

            // ìºë¦­í„°
            ctx.save();
            if (!this.facingRight) {
                ctx.translate(this.x + this.w, this.y);
                ctx.scale(-1, 1);
                ctx.drawImage(this.img, 0, 0, this.w, this.h);
            } else {
                ctx.drawImage(this.img, this.x, this.y, this.w, this.h);
            }
            ctx.restore();

            // ì¿¨ë‹¤ìš´ í‘œì‹œ (ë¨¸ë¦¬ ìœ„ ë°”)
            if (this.cooldown > 0) {
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.fillRect(this.x, this.y - 10, this.w * (this.cooldown/60), 5);
            }
        }
    }

    // íˆ¬ì‚¬ì²´ í´ë˜ìŠ¤
    class Projectile {
        constructor(x, y, dir, type, color, isHostile) {
            this.x = x;
            this.y = y;
            this.dir = dir;
            this.speed = 8;
            this.type = type;
            this.color = color;
            this.isHostile = isHostile; // trueë©´ í”Œë ˆì´ì–´ë¥¼ ì•„í”„ê²Œ í•¨
            this.size = 20;
            this.remove = false;
        }

        update() {
            this.x += this.speed * this.dir;
            if (this.x < -50 || this.x > canvas.width + 50) this.remove = true;
        }

        draw() {
            ctx.font = '30px Arial';
            ctx.fillStyle = this.color;
            ctx.fillText(this.type, this.x, this.y);
        }
    }

    let p1, cpu;
    let projectiles = [];

    // ì´ˆê¸°í™”
    function init() {
        // ì´ë¯¸ì§€ ë¡œë”© ë° ì„ íƒì°½ ìƒì„±
        const grid = document.getElementById('char-grid');
        IMG_FILES.forEach((src, i) => {
            const img = new Image();
            img.src = src;
            images.push(img);

            const slot = document.createElement('div');
            slot.className = 'char-slot';
            if (i===0) slot.classList.add('selected');
            
            const slotImg = document.createElement('img');
            slotImg.src = src;
            slot.appendChild(slotImg);
            
            slot.onclick = () => {
                document.querySelectorAll('.char-slot').forEach(s => s.classList.remove('selected'));
                slot.classList.add('selected');
                p1CharIdx = i;
            };
            grid.appendChild(slot);
        });

        // í„°ì¹˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        bindTouch('btn-left', 'left');
        bindTouch('btn-right', 'right');
        bindTouch('btn-jump', 'up');
        bindTouch('btn-atk', 'atk');

        document.getElementById('start-btn').onclick = startGame;
    }

    function bindTouch(id, keyName) {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[keyName] = true; });
        el.addEventListener('touchend', (e) => { e.preventDefault(); keys[keyName] = false; });
        // PC ë§ˆìš°ìŠ¤ í…ŒìŠ¤íŠ¸ìš©
        el.addEventListener('mousedown', (e) => { keys[keyName] = true; });
        el.addEventListener('mouseup', (e) => { keys[keyName] = false; });
    }

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('mobile-controls').style.display = 'block';
        document.getElementById('hud').style.display = 'flex';
        
        // CPU ìºë¦­í„°ëŠ” ëœë¤
        p2CharIdx = Math.floor(Math.random() * IMG_FILES.length);
        
        // ê²Œì„ ê°ì²´ ìƒì„±
        p1 = new Fighter(100, false, p1CharIdx);
        cpu = new Fighter(canvas.width - 200, true, p2CharIdx);
        projectiles = [];
        
        gameState = 'PLAY';
        loop();
    }

    function loop() {
        if (gameState !== 'PLAY') return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ë°°ê²½
        ctx.fillStyle = '#654321';
        ctx.fillRect(0, canvas.height - GROUND_H, canvas.width, GROUND_H);
        ctx.fillStyle = '#2ecc71';
        ctx.fillRect(0, canvas.height - GROUND_H, canvas.width, 20);

        // ì—…ë°ì´íŠ¸ & ê·¸ë¦¬ê¸°
        p1.update(cpu);
        p1.draw();
        cpu.update(p1);
        cpu.draw();

        // íˆ¬ì‚¬ì²´ ì²˜ë¦¬
        projectiles.forEach(p => {
            p.update();
            p.draw();
            
            // ì¶©ëŒ ì²´í¬
            const target = p.isHostile ? p1 : cpu;
            if (!p.remove && 
                p.x > target.x && p.x < target.x + target.w &&
                p.y > target.y && p.y < target.y + target.h) {
                    
                p.remove = true;
                target.hp -= 10;
                updateHP();
                
                // í”¼ê²© íš¨ê³¼ (ê°„ë‹¨íˆ í”ë“¤ë¦¼)
                target.x += (p.dir * 10);
                
                if (target.hp <= 0) endGame(p.isHostile ? 'LOSE' : 'WIN');
            }
        });
        projectiles = projectiles.filter(p => !p.remove);

        gameLoopId = requestAnimationFrame(loop);
    }

    function updateHP() {
        document.getElementById('p1-hp').style.width = Math.max(0, p1.hp) + '%';
        document.getElementById('p2-hp').style.width = Math.max(0, cpu.hp) + '%';
    }

    function endGame(result) {
        gameState = 'END';
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('mobile-controls').style.display = 'none';
        
        const txt = document.getElementById('result-text');
        if (result === 'WIN') {
            txt.innerText = "YOU WIN! ğŸ‰";
            txt.style.color = "#f1c40f";
        } else {
            txt.innerText = "YOU LOSE... ğŸ˜­";
            txt.style.color = "#e74c3c";
        }
    }

    window.onload = init;

</script>
</body>
</html>